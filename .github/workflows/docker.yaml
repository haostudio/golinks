name: Docker
on:
  push:
    tags:
      - v*
jobs:
  build-publish:
    name: publish docker image
    runs-on: ubuntu-latest
    steps:
      - name: login to docker hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - name: checkout
        uses: actions/checkout@master
      - run: git fetch --tags --unshallow
      - name: publish with version tag
        run: make docker docker-push
      - name: publish with latest tag
        run: DOCKER_TAG=latest make docker docker-push
